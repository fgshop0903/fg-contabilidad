{% extends 'core/base.html' %}
{% block content %}

<style>
    /* Estilos para los Filtros (Pills) */
    .filter-pill {
        cursor: pointer;
        transition: all 0.3s ease;
        border: 1px solid transparent;
        font-weight: 600;
        font-size: 0.75rem;
    }
    .filter-pill:hover {
        transform: translateY(-2px);
        filter: brightness(0.9);
    }
    .filter-pill.active {
        border-color: var(--primary);
        box-shadow: 0 4px 10px rgba(19, 112, 182, 0.15);
        background-color: var(--primary) !important;
        color: white !important;
    }

    /* Input de búsqueda estilo Fintech */
    .form-control-fintech {
        background: rgba(255, 255, 255, 0.5);
        border: 1px solid var(--glass-border);
        border-radius: 12px;
        padding: 10px 15px;
        transition: all 0.3s ease;
    }
    .form-control-fintech:focus {
        background: white;
        border-color: var(--primary);
        box-shadow: 0 0 0 4px var(--primary-soft);
    }

    /* Tabla Pro */
    .table-modern thead th {
        background: rgba(248, 250, 252, 0.5);
        color: var(--text-muted);
        font-size: 0.7rem;
        text-transform: uppercase;
        font-weight: 800;
        letter-spacing: 0.5px;
        padding: 15px;
        border-bottom: 2px solid var(--glass-border);
    }

    .table-modern tbody td {
        padding: 15px;
        vertical-align: middle;
        border-bottom: 1px solid rgba(0,0,0,0.03);
        font-size: 0.85rem;
    }

    /* Acción Icons */
    .action-icon {
        width: 32px;
        height: 32px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border-radius: 8px;
        background: white;
        border: 1px solid var(--glass-border);
        transition: all 0.2s;
        text-decoration: none;
    }
    .action-icon:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.05);
    }
</style>

<div class="dashboard-container container-fluid px-3">
    
    <!-- ENCABEZADO Y BOTONES -->
    <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-4 gap-3">
        <div>
            <h3 class="fw-800 mb-1" style="color: var(--text-dark); letter-spacing: -1px;">
                <i class="fa-solid fa-boxes-stacked text-primary me-2"></i> Control de Inventario
            </h3>
            <p class="text-muted small mb-0">Gestión inteligente de existencias y precios</p>
        </div>
        <div class="d-flex gap-2">
            <a href="{% url 'lista_categorias' %}" class="btn btn-white border shadow-sm rounded-3 px-3 small fw-bold">
                <i class="fa-solid fa-layer-group me-1 text-primary"></i> Categorías
            </a>
            <a href="{% url 'registrar_compra_manual' %}" class="btn btn-primary shadow-sm px-4 fw-bold">
                <i class="fa-solid fa-plus me-1"></i> Compra Manual
            </a>
        </div>
    </div>

    <!-- TARJETAS DE RESUMEN (Summary Cards) -->
    <div class="row g-3 mb-4">
        <div class="col-md-3">
            <div class="glass-card p-3 border-0 shadow-sm d-flex align-items-center">
                <div class="bg-primary-soft text-primary rounded-3 p-3 me-3">
                    <i class="fa-solid fa-tag"></i>
                </div>
                <div>
                    <small class="text-muted fw-bold d-block" style="font-size: 0.65rem;">TOTAL PRODUCTOS</small>
                    <span class="fw-800 fs-5">{{ productos|length }}</span>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="glass-card p-3 border-0 shadow-sm d-flex align-items-center">
                <div class="bg-soft-danger text-danger rounded-3 p-3 me-3" style="background: rgba(239, 68, 68, 0.1);">
                    <i class="fa-solid fa-triangle-exclamation"></i>
                </div>
                <div>
                    <small class="text-muted fw-bold d-block" style="font-size: 0.65rem;">STOCK AGOTADO</small>
                    <span class="fw-800 fs-5 text-danger" id="count-out">0</span>
                </div>
            </div>
        </div>
    </div>

    <!-- BARRA DE BÚSQUEDA Y FILTROS (Style Glass) -->
    <div class="glass-card mb-4 p-3 border-0 shadow-sm">
        <div class="row g-3 align-items-center">
            <div class="col-12 col-lg-4">
                <div class="input-group">
                    <span class="input-group-text bg-transparent border-end-0 text-muted" style="border-radius: 12px 0 0 12px; border-color: var(--glass-border);">
                        <i class="fa-solid fa-magnifying-glass"></i>
                    </span>
                    <input type="text" id="inputBuscador" class="form-control form-control-fintech border-start-0 ps-0" 
                           placeholder="Buscar por nombre, SKU o alias..." style="border-radius: 0 12px 12px 0;">
                </div>
            </div>

            <div class="col-12 col-md-4 col-lg-3">
                <select id="selectCategoria" class="form-select form-control-fintech">
                    <option value="todos">Todas las categorías</option>
                    {% for cat in categorias %}
                    <option value="{{ cat.nombre }}">{{ cat.nombre }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="col-12 col-lg-5">
                <div class="d-flex gap-2 flex-wrap justify-content-lg-end">
                    <div class="filter-pill active badge bg-primary bg-opacity-10 text-primary p-2 px-3 rounded-pill" data-filter="all">
                        Ver Todo
                    </div>
                    <div class="filter-pill badge bg-warning bg-opacity-10 text-warning p-2 px-3 rounded-pill" data-filter="low">
                        <i class="fa-solid fa-clock-rotate-left me-1"></i> Stock Bajo
                    </div>
                    <div class="filter-pill badge bg-danger bg-opacity-10 text-danger p-2 px-3 rounded-pill" data-filter="out">
                        <i class="fa-solid fa-circle-xmark me-1"></i> Agotados
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- TABLA DE PRODUCTOS -->
    <div class="glass-card p-0 overflow-hidden shadow-sm">
        <div class="table-responsive">
            <table class="table table-modern mb-0" id="tablaProductos">
                <thead>
                    <tr>
                        <th style="width: 15%;">SKU / Código</th>
                        <th style="width: 30%;">Producto</th>
                        <th style="width: 15%;">Categoría</th>
                        <th style="width: 12%; text-align: center;">Stock</th>
                        <th style="width: 12%; text-align: right;">P. Compra</th>
                        <th style="width: 12%; text-align: right;">P. Venta Sug.</th>
                        <th style="width: 10%; text-align: center;">Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for p in productos %}
                    <tr class="producto-row" 
                        data-nombre="{{ p.nombre_interno|lower }}" 
                        data-sku="{{ p.sku|lower }}" 
                        data-alias="{{ p.nombres_alternativos|join:' '|lower }}"
                        data-categoria="{{ p.categoria.nombre|default:'General' }}"
                        data-stock="{{ p.stock_actual }}">
                        
                        <!-- SKU -->
                        <td>
                            <code class="fw-bold text-primary" style="background: rgba(19, 112, 182, 0.05); padding: 3px 8px; border-radius: 6px; font-size: 0.75rem;">
                                {{ p.sku|default:"S/SKU" }}
                            </code>
                        </td>

                        <!-- Nombre -->
                        <td>
                            <div class="fw-800 text-dark">{{ p.nombre_interno }}</div>
                            <span class="text-muted" style="font-size: 0.7rem; font-style: italic;">
                                {{ p.nombres_alternativos|join:", "|truncatechars:45|default:"Sin alias" }}
                            </span>
                        </td>

                        <!-- Categoría -->
                        <td>
                            <span class="badge bg-light text-muted border fw-normal">
                                {{ p.categoria.nombre|default:"General" }}
                            </span>
                        </td>

                        <!-- Stock Badge Soft -->
                        <td class="text-center">
                            {% if p.stock_actual == 0 %}
                                <span class="badge bg-danger bg-opacity-10 text-danger rounded-pill px-3">AGOTADO</span>
                            {% elif p.stock_actual < 5 %}
                                <span class="badge bg-warning bg-opacity-10 text-warning rounded-pill px-3">{{ p.stock_actual|floatformat:1 }}</span>
                            {% else %}
                                <span class="badge bg-success bg-opacity-10 text-success rounded-pill px-3">{{ p.stock_actual|floatformat:1 }}</span>
                            {% endif %}
                        </td>

                        <!-- Precios -->
                        <td class="text-end fw-bold">S/ {{ p.precio_compra_referencial|floatformat:2 }}</td>
                        <td class="text-end fw-800 text-primary">S/ {{ p.precio_venta_referencial|floatformat:2 }}</td>

                        <!-- Acciones -->
                        <td class="text-center">
                            <div class="d-flex justify-content-center gap-1">
                                <a href="{% url 'editar_producto' p.id %}" class="action-icon" title="Editar">
                                    <i class="fa-solid fa-pen-to-square text-warning"></i>
                                </a>
                                <a href="{% url 'producto_kardex' p.id %}" class="action-icon" title="Kardex">
                                    <i class="fa-solid fa-clock-rotate-left text-info"></i>
                                </a>
                                <a href="{% url 'ajustar_stock' p.id %}" class="action-icon" title="Ajuste">
                                    <i class="fa-solid fa-sliders text-danger"></i>
                                </a>
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="7" class="text-center py-5">
                            <i class="fa-solid fa-boxes-packing fa-4x text-muted opacity-25 mb-3"></i>
                            <p class="text-muted">No se encontraron productos.</p>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Contador de Resultados al pie -->
    <div class="mt-3 text-end px-2">
        <small class="text-muted fw-bold" id="contador-resultados">
            Mostrando {{ productos|length }} de {{ productos|length }} productos
        </small>
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function() {
    const input = document.getElementById('inputBuscador');
    const selectCat = document.getElementById('selectCategoria');
    const pills = document.querySelectorAll('.filter-pill');
    const rows = document.querySelectorAll('.producto-row');
    const contador = document.getElementById('contador-resultados');
    const countOutLabel = document.getElementById('count-out');

    let currentFilter = 'all';

    // Función para contar agotados inicialmente
    function updateAgotadosCount() {
        let out = 0;
        rows.forEach(r => { if(parseFloat(r.dataset.stock) <= 0) out++; });
        countOutLabel.innerText = out;
    }
    updateAgotadosCount();

    function filtrar() {
        const busqueda = input.value.toLowerCase();
        const categoria = selectCat.value;
        let mostrados = 0;

        rows.forEach(row => {
            const nombre = row.dataset.nombre;
            const sku = row.dataset.sku;
            const alias = row.dataset.alias;
            const cat = row.dataset.categoria;
            const stock = parseFloat(row.dataset.stock);

            const coincideTexto = nombre.includes(busqueda) || sku.includes(busqueda) || alias.includes(busqueda);
            const coincideCat = (categoria === 'todos' || cat === categoria);

            let coincideSalud = false;
            if (currentFilter === 'all') coincideSalud = true;
            else if (currentFilter === 'low') coincideSalud = (stock > 0 && stock < 5);
            else if (currentFilter === 'out') coincideSalud = (stock <= 0);

            if (coincideTexto && coincideCat && coincideSalud) {
                row.style.display = "";
                mostrados++;
            } else {
                row.style.display = "none";
            }
        });

        contador.innerText = `Mostrando ${mostrados} de ${rows.length} productos`;
    }

    input.addEventListener('keyup', filtrar);
    selectCat.addEventListener('change', filtrar);

    pills.forEach(pill => {
        pill.addEventListener('click', function() {
            pills.forEach(p => p.classList.remove('active'));
            this.classList.add('active');
            currentFilter = this.dataset.filter;
            filtrar();
        });
    });
});
</script>

{% endblock %}